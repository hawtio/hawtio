name: E2E Test

on:
  pull_request_target:
    branches:
      - main
      - 4.x
    paths-ignore:
      - "**.md"
  push:
    branches:
      - main
      - 4.x
    paths-ignore:
      - "**.md"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: ["17"]
        # Disable runtime "quarkus-keycloak" until Quarkus 3.31.2 is released
        # https://github.com/quarkusio/quarkus/pull/52332
        runtime: ["quarkus", "springboot"]
        browser: ["firefox"] # chrome disabled because of https://github.com/hawtio/hawtio-next/issues/478
    env:
      REPORT_DIR: results-${{matrix.runtime}}-${{matrix.java}}-${{matrix.browser}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        if: github.event_name == 'pull_request_target'
        with:
          ref: "refs/pull/${{ github.event.number }}/merge"
      - name: Checkout code
        uses: actions/checkout@v6
        if: github.event_name == 'push'
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: ${{ matrix.java }}
          cache: "maven"
      - name: Docker Setup QEMU
        uses: docker/setup-qemu-action@v3.6.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Maven projects
        run: |
          # Phase 1: Build entire project to ensure all modules are fresh
          mvn --batch-mode --no-transfer-progress install -DskipTests
          # Phase 2: Build test modules with e2e profile to create app artifacts
          mvn --batch-mode --no-transfer-progress install -DskipTests \
            -Pe2e -pl :hawtio-tests-${{matrix.runtime}} -am
      - name: Build hawtio-test-suite image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: tests/hawtio-test-suite/Dockerfile
          build-args: |
            JAVA_VERSION=${{ matrix.java }}
          tags: hawtio-test-suite:${{ matrix.java }}
          load: true
          cache-from: type=gha,scope=hawtio-test-suite-${{ matrix.java }}
          cache-to: type=gha,mode=max,scope=hawtio-test-suite-${{ matrix.java }}
      - name: Build hawtio-${{ matrix.runtime }}-app image
        uses: docker/build-push-action@v6
        with:
          context: tests/${{ matrix.runtime }}
          file: tests/${{ matrix.runtime }}/Dockerfile
          build-args: |
            JAVA_VERSION=${{ matrix.java }}
          tags: hawtio-${{ matrix.runtime }}-app:${{ matrix.java }}
          load: true
          cache-from: type=gha,scope=${{ matrix.runtime }}-app-${{ matrix.java }}
          cache-to: type=gha,mode=max,scope=${{ matrix.runtime }}-app-${{ matrix.java }}
      - name: ${{ matrix.runtime }} E2E test (Java ${{ matrix.java }})
        id: test
        run: |
          runtime=${{matrix.runtime}}
          extra_args=''
          if [[ $runtime =~ "-keycloak" ]]; then
            runtime=${runtime%-keycloak}
            extra_args='-Dio.hawt.test.use.keycloak=true'
          fi
          docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $PWD/$REPORT_DIR:/workspace/tests/hawtio-test-suite/target \
          -v $PWD/$REPORT_DIR/build:/workspace/tests/hawtio-test-suite/build/ \
          --shm-size="2g" \
            hawtio-test-suite:${{ matrix.java }} -Pe2e-${runtime} -Dselenide.browser=${{ matrix.browser }} \
            -Dio.hawt.test.docker.image=hawtio-${runtime}-app:${{ matrix.java }} $extra_args
      - name: Archive test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "test-results-${{ matrix.runtime }}-java-${{ matrix.java }}-${{ matrix.browser }}"
          path: |
            ${{ env.REPORT_DIR }}/build/reports/tests/*.png
            ${{ env.REPORT_DIR }}/*.log
            ${{ env.REPORT_DIR }}/cucumber-reports/*

  publish-results:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    permissions:
      checks: write
      actions: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Archive failed test reports
        uses: actions/upload-artifact/merge@v4
        if: always()
        with:
          name: "test-results"
          pattern: test-results-*
          separate-directories: true
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          name: "test-results"
          path: "test-results"
      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/Cucumber.xml
          json_file: results.json
      - name: Install xmllint
        run: sudo apt-get install -y xmlstarlet jq
      - name: Generate summary
        run: |
          export CHECK_URL=$(jq -r .check_url results.json)
          bash tests/hawtio-test-suite/process_test_results.sh test-results > summary.md
      - name: Update summary
        run: |
          cat summary.md >> $GITHUB_STEP_SUMMARY
      - uses: tibdex/github-app-token@v2
        if: github.event_name == 'pull_request_target'
        id: generate-token
        with:
          app_id: ${{ secrets.HAWTIO_CI_APP_ID }}
          private_key: ${{ secrets.HAWTIO_CI_PRIVATE_KEY }}
      - name: Comment PR with summary
        if: github.event_name == 'pull_request_target'
        uses: thollander/actions-comment-pull-request@v2
        with:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          filePath: summary.md
          comment_tag: execution
